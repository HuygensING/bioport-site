<html metal:use-macro="context/@@admin_template/macros/master">
<div metal:fill-slot="content"
	class="person_edit"
    tal:define="
    	merged_bio view/merged_biography;
    	bioport_bio view/bioport_biography; 
    	" 
    >
 <style>

 </style>
<script>
show = function(element_id) {
	el = document.getElementById(element_id);
	if (el) {el.style.display='';}
}

hide = function(element_id) {
	el = document.getElementById(element_id);
	if (el) {el.style.display='none'};
}


</script>
 <script>
 $(document).ready(function(){

	 //on pressing return, make the form submit everything
	 $(function() {
	        $("form input").keypress(function (e) {
	            if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
	                $('input[name="form.actions.save_everything"]').click()
	                return false;
	            } else {
	                return true;
	            }
	        });
	    });

   $('.form_baptism').hide();
   $('.form_funeral').hide();
   $('.form_floruit').hide();
	 });
</script>

<h1>Bewerk gegevens van <em tal:content="view/title" /></h1>
<p>
De gegevens in het formulier zijn de gegevens zoals ze op het biografisch portaal worden 
<a tal:attributes="href python:view.url(context.__parent__, 'persoon', data={'bioport_id':view.bioport_id})">getoond</a>. 
</p>
<p>
De gegevens zijn grijs als ze uit de bronnen-publikaties komen, zwart als ze zijn ingevoerd door de medewerkers van het biografisch portaal.
</p>
<form action="." tal:attributes="action request/URL" method="get"
      class="edit-form" >
      <input type="hidden" name="bioport_id" tal:attributes="value python:view.bioport_id" />
<table>
    <tr>
        <th>bioport identifier</th>
        <td class="bioport" tal:content="view/person/get_bioport_id" />
    </tr>
    <tr metal:use-macro="template/macros/separator" ></tr> 
    <tr>
       <th>status</th>
       <td>
           <select name="status">
               <option></option> 
               <option tal:repeat="option python:context.repository().get_status_values()"
                   tal:attributes="value python:option[0];
                       selected python:option[0]==view.person.status"
                       tal:content="python:option[1]"></option>
           </select>
       </td>
       <td>
            <span tal:replace="structure python:view.actions.byname['form.actions.save_status'].render()" ></span>
       </td>
    </tr>
    <tr metal:define-macro="separator" class="separator" ><td colspan="3"><hr></td></tr>
    <tr tal:define="namen view/get_bioport_namen"
    	tal:repeat="idx python:range(len(namen))">
    	<th><span tal:condition="python:idx == 0" >namen</span></th>
    	<td tal:define="naam python:namen[idx]"
		    tal:attributes="class python:view.get_bioport_namen() and 'bioport' or 'merged'">
    		<span tal:content="naam/volledige_naam" />
    		<span tal:define="normal_form naam/guess_normal_form"
    		  tal:condition="python:repeat['idx'].start() and naam.volledige_naam() != normal_form"
    		  tal:content="string:[${normal_form}]"  />
		    </td>
		<td >
			<a tal:attributes="href python:view.url('changename', data={'bioport_id':view.bioport_id, 'idx':idx})">
			verander
			</a>
			<span tal:condition="python:len(namen) > 1">
			| <a tal:attributes="href python:view.url(data={'form.actions.remove_name':'', 'naam_idx':idx, 'bioport_id':view.bioport_id})"  >verwijder </a>
			| <a href="" onclick="alert('nog niet geimplementeerd')"> omhoog </a>
			| <a href="" onclick="alert('nog niet geimplementeerd')"> omlaag </a>
			</span>
		</td>    
   	</tr>

   		
    <tr tal:condition="not:view/get_bioport_namen" 
    tal:define="namen view/get_non_bioport_namen"
    	tal:repeat="idx python:range(len(namen))">

    	<th><span tal:condition="python:idx == 0" >namen</span></th>
    	<td tal:define="naam python:namen[idx]"
		    tal:attributes="class python:view.get_bioport_namen() and 'bioport' or 'merged'">
    		<span tal:replace="naam/volledige_naam" />
    		<span tal:define="normal_form naam/guess_normal_form"
    		  tal:condition="python:repeat['idx'].start() and naam.volledige_naam() != normal_form"
    		  tal:content="string:[${normal_form}]"  />
	    </td>
		<td >
			<a tal:attributes="href python:view.url('changename', data={'bioport_id':view.bioport_id, 'idx':idx})">
			verander
			</a>
		</td>    

   	</tr>
   	
   	<tr>
   		<th></th>
   		<td colspan="2">
   	        <input name="name_new" type="text" id="name_new"  />
	        <span tal:replace="structure python:view.actions.byname['form.actions.add_name'].render()" ></span>
		</td>    
	</tr>
   	<tr metal:use-macro="template/macros/separator" /> 	
	<tr>
		<th>geslacht</th>
		<td tal:define="sex python:view.merged_biography.get_value('geslacht')"
			tal:attributes="class python:not view.bioport_biography.get_value('geslacht') and 'merged'">
			<select name="sex">
				<option></option>	
				<option tal:repeat="option view/sex_options"
					tal:attributes="value python:option[0];
						selected python:option[0] == view.merged_biography.get_value('geslacht') "
					tal:content="python:option[1]">man</option>
			</select>	
		
		</td>
		<td>
	        <span tal:replace="structure python:view.actions.byname['form.actions.save_sex'].render()" />
        </td> 
	</tr>

    <!-- geboortedatum -->
    <span tal:omit-tag=""
    	 tal:define="title string:geboorte;
    	 	event_type string:birth;"
    	 >
    <div metal:define-macro="event_form"
	    tal:define="
    		event python:view.get_event(event_type);
	    	show_exact python:(not event) or (event.when or not (event.notAfter or event.notBefore or event.date_text));
			show_approx python:event and (event.notAfter or event.notBefore or event.date_text) and True;
    		has_data python:show_approx or (event and event.when);
			prefix event_type;
        	">
	<tr tal:attributes="class string:separator" ><td colspan="3"><hr></td></tr>
   
    <tr  tal:attributes="id event_type; 
	    "> 
        <th tal:content="title">geboorte</th>
         <td><a href="" 
            tal:condition="not:has_data" 
            tal:attributes="onClick string: jQuery('.form_${event_type}').show();; jQuery(this).hide();;  return false;;;
            class string:button_show_${event_type};"
            >[toon]</a></td>
        <td  tal:attributes="class python:not has_data and 'form_%s' % event_type;">
	        <span tal:replace="structure python:view.actions.byname['form.actions.save_event_%s' % event_type].render()" />
        </td> 
     </tr>
     <tr tal:attributes="
     	id string:${event_type}_exact;
        class python:not has_data and 'form_%s' % event_type;
		style python:not show_exact and 'display:none'">
     	<th class="sublabel">datum
     	</th>
        <td colspan="2"  tal:attributes="class python:view.status_value(event_type, 'when')"
        	tal:define="ymd event/when_ymd | nothing">
 	
 		<span metal:define-macro="date_widget" tal:omit-tag="">
        	<select tal:attributes="name string:${prefix}_d">
        		<option />
        		<option 
	        		tal:repeat="option python:range(1, 32)" 
	        		tal:attributes="selected python:ymd and ymd[2] == option"
	        		tal:content="option"
        		/>
        	</select>
        	<select tal:attributes="name string:${prefix}_m">
         		<option>
        		<option 
	        		tal:repeat="option python:range(1, 13)" 
	        		tal:attributes="
			        		selected python:ymd and ymd[1] == option;
	        			value option;"
	        		tal:content="python:view.maanden()[option-1]"
        		/>
        	</select>
        	<input  type="text" size="4" style="width:4"
        		tal:attributes="name string:${prefix}_y;
        			value python:ymd and ymd[0] or ''" />
		
		</span>	

    	[<a href="" 
    		tal:attributes="id string:${event_type}_button_on;
    			OnClick string:
                    jQuery('#${event_type}_notBefore').show();;
                    jQuery('#${event_type}_notAfter').show();;
                    jQuery('#${event_type}_text').show();;
                    jQuery('#${event_type}_exact').hide();;
                    jQuery('#${event_type}_button_on').hide();;
    				return false;;">exact jaar niet bekend</a>]

	    </td>	
	 </tr>
	<tr tal:attributes="id string:${event_type}_notBefore;
			style python:not show_approx and 'display:none';
			" >	 
		<th class="sublabel">na</th> 
        <td tal:attributes="class python:view.status_value(event_type, 'notBefore')"
            tal:define="
				prefix string:${event_type}_notBefore;
				ymd event/notBefore_ymd | nothing">
				<span metal:use-macro="template/macros/date_widget"></span>
		</td>
	</tr>
	<tr tal:attributes="id string:${event_type}_notAfter;
			style python:not show_approx and 'display:none';
			" >	 

		<th class="sublabel">v&oacute;&oacute;r</th> 
        <td tal:attributes="class python:view.status_value(event_type, 'notAfter')"
			tal:define="
				prefix string:${event_type}_notAfter;
				ymd event/notAfter_ymd | nothing">
			<span metal:use-macro="template/macros/date_widget" />
		</td>
	</tr>
	<tr tal:attributes="id string:${event_type}_text;
			style python:not show_approx and 'display:none';
			" >	 
		<th class="sublabel">tekst</th> 
        <td colspan="2"
        	tal:attributes="class python:view.status_value(event_type, 'date_text')">
			<input type="text" 
				tal:attributes="
					name string:${event_type}_text;
					value event/date_text | nothing" />
        	[<a href="" 
        	
        		tal:attributes="id string:${event_type}_approx_button_off;
		   			OnClick string:
						jQuery('#${event_type}_notBefore').hide();;
						jQuery('#${event_type}_notAfter').hide();;
						jQuery('#${event_type}_text').hide();;
						jQuery('#${event_type}_exact').show();;
						jQuery('#${event_type}_button_on').show();;
						jQuery('#${event_type}_button_off').hide();;
						
						return false;;">exact jaar bekend</a>]

	        </td>

    </tr>

   
    <tr tal:attributes="id string:${event_type}_place;
	        class string:form_${event_type};
	        "> 
        <th class="sublabel">plaats</th>
        <td colspan="2" tal:attributes="class python:view.status_value(event_type, 'place')">
        	<input type="tekst"  
	        	tal:attributes="name string:${event_type}_place;
		        	value event/place | nothing" />
        </td>
    </tr>
     </div> 
   	</span>	 
   	<!--  /geboorte -->
 
 	
    <!--  plaats -->
   <tr tal:condition="nothing">
    	<th class="sublabel">xxx</th>
        <td colspan="2"
        	tal:attributes="class python:view.status_value(event_type, 'place')">
        	<input type="hidden"  
	        	tal:attributes="name string:${event_type}_place_id;
		        	value event/place_id | nothing" />
		    <a 
		    
		    	tal:define="
		    		element_id string:${event_type}_place_id;
		    		url python:view.url('changelocation', data={
			    	'place_id':event and event.place_id,
			    	'element_id':element_id,
			    	})"
		    		href=""
		     
		    	tal:attributes="
		    		id element_id;
			    	onClick  string:window.open('${url}', 'locations', 'width=500,height=600,scrollbars=yes');; return false;;"
		    	tal:content="python:(event and event.place_id) or 'kies een plaats'" /> 
	        	<span tal:attributes="id string:${event_type}_place_button_on;
			        	style python:event and event.place and 'display:none';">
	        		[<a href="" 
	        		tal:attributes="OnClick string:
						show('${event_type}_place');;
						show('${event_type}_place_id');;
						hide('${event_type}_place_button_on');;
						return false;;">exacte plaats niet bekend</a>] 

				</span>
        </td>
    </tr>
    <!--  plaats -->
	    	
    <!-- dood -->
   	<span tal:omit-tag=""
   		 tal:define="
   		 	title string:dood;
   		 	event_type string:death;">
   		 <tr metal:use-macro="template/macros/event_form" />
	 </span>
	 <!-- /dood -->
	

    <!--  doop --> 
   	<span tal:omit-tag="" 
   		 tal:define="
   		 	title string:doop;
   		 	event_type string:baptism;">
   		 <tr metal:use-macro="template/macros/event_form" />
	 </span>
    <!--  /doop -->	
    
    <!--  begrafenis --> 
   	<span tal:omit-tag=""
   		 tal:define="
   		 	title string:begrafenis;
   		 	event_type string:funeral;">
   		 <tr metal:use-macro="template/macros/event_form"  />
	 </span>
	 <!-- /begrafenis --> 
	 
  	
  	<!--  floruit -->
  	<tal:block define="
  	     state_id string:floruit;
	  	 state python:view.get_state(state_id);
	  	 has_data python:state and (state.frm or state.to or state.text)">
  	<script>
//    
  	</script>
	<tr tal:attributes="class string:separator" ><td colspan="3"><hr></td></tr>
   	<tr>
        <th>actief</th>	
        <td><a 
            tal:condition="not:has_data"
            href="" onClick="
			$('.form_floruit').show();	
            $(this).hide(); 
            return false;">[toon]</a></td>
        <td tal:attributes="class python:not has_data and 'form_%s'  % state_id">
	        <span tal:replace="structure python:view.actions.byname['form.actions.save_state_floruit'].render()" ></span>
 	   </td>
   	</tr>
   	<tr tal:attributes="class python:not has_data and 'form_%s' % state_id">
   	    <th class="sublabel">van</th>
        <td tal:attributes="class python:view.status_value('floruit', 'frm')"
            tal:define="
				prefix string:state_floruit_from;
				ymd state/frm_ymd | nothing">
				<span metal:use-macro="template/macros/date_widget"></span>
		</td>
    </tr>
   	<tr tal:attributes="class python:not has_data and 'form_%s' % state_id">
   	    <th class="sublabel">tot</th>
         <td tal:attributes="class python:view.status_value('floruit', 'to')"
            tal:define="
				prefix string:state_floruit_to;
				ymd state/to_ymd| nothing">
				<span metal:use-macro="template/macros/date_widget"></span>
		</td>
    </tr>
   	<tr tal:attributes="class python:not has_data and 'form_%s' % state_id">
        <th class="sublabel">tekst</th>
        <td tal:attributes="class python:view.status_value('floruit', 'text')">
            <input tal:attributes="name python:'state_%s_text' % 'floruit';
                value state/text | nothing;
                " >
        </td>
    </tr>
  	</tal:block>
  	<!--  /floruit -->
	   	
  	<tr metal:use-macro="template/macros/separator" ></tr> 
  	
   	<!--  beroep -->
   	<tal:block repeat="state view/occupations">
   	<tr tal:condition="state/idno" >
   		<th><span tal:condition="repeat/state/start">beroepen</span></th>
   		<td>
   			<select tal:attributes="name string:occupation_id">
   				<option></option>
   				<option tal:repeat="occupation python:view.repository.get_occupations()" 
   					tal:content="occupation/name"
   					tal:attributes="value occupation/id;
   					    selected python:state.idno == str(occupation.id)"></option>
   			</select>	
   		</td>
        <td>
	        <span 
	           tal:condition="repeat/state/start" tal:replace="structure python:view.actions.byname['form.actions.save_occupation'].render()" />
        </td> 
   	</tr>	
   	</tal:block>
   	<tr>
        <th><span tal:condition="not:view/occupations">beroepen</span></th>	
        <td>
    			<select name="new_occupation_id">
   				<option></option>
   				<option tal:repeat="occupation python:view.repository.get_occupations()" 
   					tal:content="occupation/name"
   					tal:attributes="value occupation/id;"></option>
   			</select>	
        </td>
        <td>
	        <span 
	           tal:condition="not:view/occupations" tal:replace="structure python:view.actions.byname['form.actions.save_occupation'].render()" />
        </td>
   	</tr>
   	    <tr tal:repeat="i python:range(len(view.occupations), 2)">
        <th></th>   
        <td>
                <select name="new_occupation_id">
                <option></option>
                <option tal:repeat="occupation python:view.repository.get_occupations()" 
                    tal:content="occupation/name"
                    tal:attributes="value occupation/id;"></option>
            </select>   
        </td>
        <td>
        </td>
    </tr>
    <!--  /beroep --> 
	   	<tr metal:use-macro="template/macros/separator" ></tr> 
   	<tr>
        <th>opmerkingen (voor en door bewerkers)</th>	
        <td>
            <textarea name="remarks" style="width:200px" tal:content="view/person/remarks"></textarea>
        <td>
	        <span tal:replace="structure python:view.actions.byname['form.actions.save_remarks'].render()" ></span>
    	</td>
   	</tr>
<tr metal:use-macro="template/macros/separator" ></tr> 
    <tr>
   	<th />
   	<td>
        <span tal:replace="structure python:view.actions.byname['form.actions.save_everything'].render()" class="default"  />
	        <input type="reset" value="reset" />
	</td> 
    </tr>
</table>
</form>




<div class="info">
<div tal:repeat="bio view/person/get_biographies">
<h2>Bron: 
	<a tal:attributes="
	   href python:bio.get_value('url_biografie'); 
	   target python:bio.get_source().id" >
		<span tal:replace="python:bio.get_source().id"></span> - <span tal:replace="python:bio.get_source().description"></span>
	</a>
</h2>
<table >
    <tr tal:condition="python:bio.get_source().id == 'bioport'">
        <th>status</th>
	    <td tal:content="python:view.person.status and context.repository().get_status_values(view.person.status)" ></td>
    </tr>
	<tr>
		<th>namen</th>
		<td>
			<div tal:repeat="naam python:bio.get_namen()" tal:content="naam/volledige_naam"></div>	
		</td>
	</tr>
	<tr tal:Condition="python:bio.get_value('geslacht')">
		<th>geslacht</th>
		<td>
			<span tal:replace="python:dict(view.sex_options()).get(bio.get_value('geslacht'))" />
		</td>
	</tr>
	<tal:block repeat="event2 python:[('geboorte', 'birth'), ('dood', 'death'), ('doop', 'baptism'), ('begrafenis', 'funeral')]" >
	<span 
		tal:define="event python:view.get_event(event2[1], biography=bio);
			title python:event2[0]"
		tal:condition="python:event"> 
		<tr tal:condition="event/when">
			<th tal:content="python:'%s-datum' % title" />
			<td tal:content="event/when_formatted">
			</td>
		</tr> 
		<tr tal:condition="event/notBefore">
			<th tal:content="python:'%s-na' % title" />
			<td tal:content="event/notBefore_formatted">
			</td>
		</tr> 
		<tr tal:condition="event/notAfter">
			<th tal:content="python:'%s-voor' % title" />
			<td tal:content="event/notAfter_formatted">
			</td>
		</tr> 
		<tr tal:condition="event/date_text">
			<th tal:content="python:'%s-datum_tekst' % title" />
			<td tal:content="event/date_text"> </td>
		</tr> 
		<tr tal:condition="event/place">
			<th tal:content="python:'%s-plaats' % title" />
			<td tal:content="event/place"> </td>
		</tr> 
		</span>

	  </tal:block> 
<tal:block repeat="state2 python:[('beroep', 'occupation'), ('actief', 'floruit')]">
		<tal:block define="
		  state python:view.get_state(state2[1], biography=bio);
		  title python:state2[0];" 
		  
		  tal:condition="state">
		  <tr tal:condition="state/idno">
		      <th tal:content="string:${title} - idno"></th>
		      <td tal:content="state/idno" />
		  </tr> 
		  <tr tal:condition="state/text">
		      <th tal:content="string:${title} - text"></th>
		      <td tal:content="state/text" />
		  </tr> 
		  <tr tal:condition="state/frm">
		      <th tal:content="string:${title} - van"></th>
		      <td tal:content="state/frm" />
		  </tr> 
		  <tr tal:condition="state/to">
		      <th tal:content="string:${title} - tot"></th>
		      <td tal:content="state/to" />
		  </tr> 
		</tal:block>

	</tal:block>
	<tr tal:condition="python:bio.get_value('tekst')">
		<th>tekst</th>
		<td>
			<span tal:replace="python:bio.get_value('tekst')" />
		</td>
	
	</tr>	
    <tr tal:condition="python:bio.get_source().id == 'bioport' and view.person.remarks">
        <th>opmerkingen</th>
        <td tal:content="python:view.person.remarks" ></td>
    </tr>
	<tr tal:condition="python:bio.record.timestamp">
		<th>laatst veranderd</th>
		<td tal:content="python:bio.record.timestamp" ></td>
	</tr>
	</table>
</div>

</div>
<div id="right_column">
	<tal:block repeat="bio view/person/get_biographies" >
		<div class="right_column_content"
		    tal:define="tekst python:bio.get_value('tekst')"
			tal:condition="python:bio.get_source().id != 'bioport'">
			<h1 tal:content="python:bio.get_source().id"></h1>
			<div tal:content="tekst"></div>
			<p>
			 <a tal:attributes="
       href python:bio.get_value('url_biografie'); 
       target python:bio.get_source().id" >[link]</a>
			</p>
		</div>
	</tal:block>
</div>
</div>
</html>
